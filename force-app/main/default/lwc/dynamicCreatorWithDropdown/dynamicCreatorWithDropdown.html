<!-- dynamicCreatorWithDropdown.html -->
<template>
  <lightning-card>
    <div slot="title" class="slds-var-p-vertical_small">
      <div class="slds-var-p-left_medium slds-grid slds-grid_vertical-align-center" style="gap: 0.5rem;">
        <lightning-icon icon-name="action:new_notebook" size="xx-small" class="purple-icon"></lightning-icon>
        <h2 class="slds-text-heading_medium slds-text-color_default">RocketForm</h2>
      </div>
    </div>
    
    <template if:true={selectedForm}>
      <div slot="actions">
        <lightning-button
          label="Back"
          variant="neutral"
          icon-position="left"
          onclick={handleGoBack}
          class="slds-var-m-right_large">
        </lightning-button>
      </div>
    </template>
    <div class="slds-var-p-left_xx-large slds-var-p-right_xx-large slds-var-p-bottom_xx-large">
    <!-- Selected form display with 50/50 layout -->
    <div class="slds-var-p-top_x-small slds-var-p-horizontal_x-small slds-var-p-bottom_x-small">
      <template if:true={selectedForm}>
        <div class="slds-grid slds-gutters slds-grid_vertical-align-center">
          <!-- Left: Selected form display (50% width) -->
          <div class="slds-col slds-size_6-of-12">
            <div class="selected-object-display slds-var-p-around_x-small">
              <span class="selected-object-inline">{selectedFormDisplayName}</span>
            </div>
          </div>
          
          <!-- Right: Audio section (50% width) -->
          <div class="slds-col slds-size_6-of-12">
            <div class="slds-grid slds-grid_align-end">
              <div class="slds-col slds-size_8-of-12 slds-grid slds-grid_align-end">
                <div class="slds-grid slds-grid_align-end slds-media_center slds-is-relative slds-var-p-vertical_small">
                  <img src={listeningImageUrl} alt="Listening visualization" class="listening-image" />
                </div>
              </div>
            </div>
          </div>
        </div>
      </template>
    </div>


    <!-- Two-column layout when form is selected and has sections -->
    <template if:true={selectedForm}>
      <template if:true={hasSections}>
        <div class="slds-grid slds-gutters slds-var-p-around_x-small">
          
          <!-- Left Column: Enhanced Section Navigation (30% width) -->
          <div class="slds-col slds-size_4-of-12">
            <div class="section-list-container slds-theme_default slds-var-p-around_small custom-container">              
              <!-- Progress Summary -->
              <div class="slds-grid slds-grid_align-spread slds-var-m-bottom_small progress-summary-aligned">
                <div class="slds-col">
                  <span class="slds-text-body_regular">{progressValue}% Complete</span>
                </div>
                <div class="slds-col slds-text-align_right">
                  <span class="slds-text-body_small slds-text-color_weak">{filledCount} / {totalFields}</span>
                </div>
              </div>
              
              <!-- Progress Bar -->
              <div class="slds-var-m-bottom_medium">
                <lightning-progress-bar 
                  value={progressValue} 
                  variant="circular"
                  size="large">
                </lightning-progress-bar>
              </div>
              
              <!-- Vertical Progress Indicator -->
              <div class="slds-progress slds-progress_vertical">
                <ol class="slds-progress__list">
                  <template for:each={progressSteps} for:item="step">
                    <li key={step.id} class={step.cssClass}
                        data-section-id={step.sectionId}
                        onclick={handleSectionClick}
                        onkeydown={handleSectionKeyDown}
                        title="Click to focus on {step.text}"
                        tabindex="0"
                        role="button"
                        aria-label="Navigate to {step.text} section">
                      
                      <template if:true={step.isCompleted}>
                        <div class="slds-progress__marker custom-progress__marker custom-progress__marker--completed" 
                             title="Complete">
                          <span class="slds-assistive-text">Complete</span>
                        </div>
                      </template>
                      <template if:false={step.isCompleted}>
                        <div class="slds-progress__marker custom-progress__marker">
                          <template if:true={step.isActive}>
                            <span class="slds-assistive-text">Active</span>
                          </template>
                        </div>
                      </template>
                      
                      <div class="slds-progress__item_content custom-progress-content slds-grid slds-grid_align-spread">
                        <div class="slds-col slds-grow">
                          <h4 class="slds-text-body_regular">{step.text}</h4>
                        </div>
                        <div class="slds-col slds-no-flex">
                          <template if:true={step.completedFields}>
                            <template if:true={step.isCompleted}>
                              <span class="slds-text-body_small slds-text-color_weak">
                                <lightning-icon icon-name="utility:check" size="xx-small" class="slds-var-m-right_small green-check-icon"></lightning-icon>
                                {step.completedFields} / {step.totalFields}
                              </span>
                            </template>
                            <template if:false={step.isCompleted}>
                              <span class="slds-text-body_small slds-text-color_weak">
                                {step.completedFields} / {step.totalFields}
                              </span>
                            </template>
                          </template>
                        </div>
                      </div>
                    </li>
                  </template>
                </ol>
              </div>
            </div>
          </div>

          <!-- Right Column: Record Creation Form (70% width) -->
          <div class="slds-col slds-size_8-of-12">
            <div class="slds-box slds-theme_default slds-var-p-around_x-small custom-container info-block">

            <!-- Section-based Form Layout -->
            <template if:true={fieldsArray.length}>
              <template if:false={isLoadingFields}>
                <lightning-record-edit-form
                  object-api-name={selectedObject}
                  record-type-id={recordTypeId}
                  onsuccess={handleSuccess}
                  onerror={handleError}
                >
                  <lightning-messages></lightning-messages>
                  
                  <!-- Section-based layout with 2-column fields -->
                  <template for:each={sectionsWithProgress} for:item="section">
                    <div key={section.sectionId} 
                         class="slds-var-m-bottom_small section-container" 
                         data-section-id={section.sectionId}>
                      
                      <!-- Section Header -->
                      <div class="slds-grid slds-gutters slds-grid_align-spread slds-var-m-bottom_xx-small">
                        <div class="slds-col slds-grow">
                          <h3 class="section-header slds-var-m-left_x-small">
                            {section.sectionName}
                          </h3>
                        </div>
                      </div>
                      
                      <!-- 2-Column Field Grid -->
                      <template if:true={section.hasFields}>
                        <div class="slds-grid slds-wrap minimal-gap-grid">
                          <template for:each={section.fieldComponents} for:item="field">
                            <div key={field.apiName} class={field.cssClass}>
                              <lightning-input-field
                                field-name={field.apiName}
                                onchange={handleFieldChange}
                                data-field-name={field.apiName}
                              ></lightning-input-field>
                            </div>
                          </template>
                        </div>
                      </template>
                      
                      <!-- Empty section message -->
                      <template if:false={section.hasFields}>
                        <div class="slds-text-align_center slds-var-p-vertical_medium">
                          <p class="slds-text-body_small slds-text-color_weak">
                            No fields configured for this section
                          </p>
                        </div>
                      </template>
                    </div>
                  </template>
                  
                  <!-- Submit buttons -->
                  <div class="slds-var-p-top_medium slds-text-align_right slds-border_top slds-var-p-top_medium">
                    <lightning-button 
                      label="Cancel"
                      variant="neutral"
                      onclick={handleCancel}
                      class="slds-var-m-right_x-small">
                    </lightning-button>
                    <lightning-button 
                      type="submit" 
                      label={createButtonLabel}
                      variant="brand">
                    </lightning-button>
                  </div>
                </lightning-record-edit-form>
              </template>
            </template>
            
            <!-- Loading state -->
            <template if:true={isLoadingFields}>
              <div class="slds-var-p-around_x-small slds-text-align_center">
                <lightning-spinner alternative-text="Loading metadata..." size="small"></lightning-spinner>
                <p class="slds-var-m-top_x-small slds-text-body_small slds-text-color_weak">
                  Loading {selectedObject} fields...
                </p>
              </div>
            </template>
            
            <!-- No fields available -->
            <template if:true={selectedForm}>
              <template if:false={fieldsArray.length}>
                <template if:false={isLoadingFields}>
                  <div class="slds-var-p-around_x-small slds-text-align_center">
                    <lightning-icon icon-name="utility:info" size="small" class="slds-var-m-bottom_x-small"></lightning-icon>
                    <p class="slds-text-body_regular slds-text-color_weak">
                      No fields available for {selectedObject}
                    </p>
                  </div>
                </template>
              </template>
            </template>
            </div>
          </div>
        </div>
      </template>
      
      <!-- Full-width layout when object is selected but no sections -->
      <template if:false={hasSections}>
        <div class="slds-var-p-around_x-small">
          <div class="slds-box slds-theme_default slds-var-p-around_x-small info-block">

            <!-- Form fields -->
            <template if:true={fieldsArray.length}>
              <template if:false={isLoadingFields}>
                <lightning-record-edit-form
                  object-api-name={selectedObject}
                  record-type-id={recordTypeId}
                  onsuccess={handleSuccess}
                  onerror={handleError}
                >
                  <lightning-messages></lightning-messages>
                  
                  <!-- 2-column form layout (no sections) -->
                  <div class="slds-grid slds-wrap minimal-gap-grid">
                    <template for:each={fieldsArray} for:item="fld">
                      <div key={fld.apiName} class={fld.cssClass}>
                        <lightning-input-field
                          field-name={fld.apiName}
                          onchange={handleFieldChange}
                          data-field-name={fld.apiName}
                        ></lightning-input-field>
                      </div>
                    </template>
                  </div>
                  
                  <div class="slds-var-p-top_x-small slds-text-align_right">
                    <lightning-button 
                      label="Cancel"
                      variant="neutral"
                      onclick={handleCancel}
                      class="slds-var-m-right_x-small">
                    </lightning-button>
                    <lightning-button 
                      type="submit" 
                      label={createButtonLabel}
                      variant="brand">
                    </lightning-button>
                  </div>
                </lightning-record-edit-form>
              </template>
            </template>
            
            <!-- Loading state -->
            <template if:true={isLoadingFields}>
              <div class="slds-var-p-around_x-small slds-text-align_center">
                <lightning-spinner alternative-text="Loading metadata..." size="small"></lightning-spinner>
                <p class="slds-var-m-top_x-small slds-text-body_small slds-text-color_weak">
                  Loading {selectedObject} fields...
                </p>
              </div>
            </template>
            
            <!-- No fields available -->
            <template if:true={selectedForm}>
              <template if:false={fieldsArray.length}>
                <template if:false={isLoadingFields}>
                  <div class="slds-var-p-around_x-small slds-text-align_center">
                    <lightning-icon icon-name="utility:info" size="small" class="slds-var-m-bottom_x-small"></lightning-icon>
                    <p class="slds-text-body_regular slds-text-color_weak">
                      No fields available for {selectedObject}
                    </p>
                  </div>
                </template>
              </template>
            </template>
          </div>
        </div>
      </template>
    </template>

    <!-- No local form selector UI; deep link only -->
    </div>
  </lightning-card>
</template>
