<template>
    <lightning-card title="Dynamic Field Analysis Wizard" icon-name="utility:steps" class="wizard-container">
        
        <!-- Progress Indicator -->
        <div class="slds-var-p-around_medium">
            <lightning-progress-indicator 
                current-step={currentStep} 
                type="path" 
                variant="base">
                <lightning-progress-step 
                    label="Object Selection" 
                    value="step1">
                </lightning-progress-step>
                <lightning-progress-step 
                    label="Field Analysis" 
                    value="step2">
                </lightning-progress-step>
                <lightning-progress-step 
                    label="Create Instructions" 
                    value="step3">
                </lightning-progress-step>
                <lightning-progress-step 
                    label="Review & Save" 
                    value="step4">
                </lightning-progress-step>
            </lightning-progress-indicator>
        </div>

        <!-- Step Content -->
        <div class="slds-var-p-around_medium step-content">
            
            <!-- Step 1: Object & Record Type Selection -->
            <template if:true={isStep1}>
                <div class="slds-grid slds-gutters slds-wrap">
                    <div class="slds-col slds-size_1-of-1 slds-large-size_6-of-12">
                        <lightning-card title="Select Object" icon-name="utility:database">
                            <div class="slds-var-p-around_medium">
                                <lightning-combobox
                                    name="objectSelector"
                                    label="Salesforce Object"
                                    placeholder="Choose an object to analyze"
                                    options={objectOptions}
                                    value={selectedObject}
                                    onchange={handleObjectChange}
                                    variant="label-stacked"
                                    required>
                                </lightning-combobox>
                                
                                <!-- Loading States -->
                                <template if:true={isLoadingRecordTypes}>
                                    <div class="slds-var-m-top_medium slds-text-align_center">
                                        <lightning-spinner alternative-text="Loading record types..." size="small"></lightning-spinner>
                                        <p class="slds-var-m-top_small slds-text-body_small">Loading record types...</p>
                                    </div>
                                </template>

                                <!-- Record Type Selection -->
                                <template if:true={showRecordTypeSelector}>
                                    <div class="slds-var-m-top_medium">
                                        <lightning-combobox
                                            name="recordTypeSelector"
                                            label="Record Type"
                                            placeholder="Choose a record type"
                                            options={recordTypeOptions}
                                            value={selectedRecordType}
                                            onchange={handleRecordTypeChange}
                                            variant="label-stacked"
                                            required>
                                        </lightning-combobox>
                                        <template if:true={selectedRecordTypeDescription}>
                                            <div class="slds-text-body_small slds-text-color_weak slds-var-m-top_x-small">
                                                {selectedRecordTypeDescription}
                                            </div>
                                        </template>
                                    </div>
                                </template>
                            </div>
                        </lightning-card>
                    </div>
                    
                    <div class="slds-col slds-size_1-of-1 slds-large-size_6-of-12">
                        <lightning-card title="Object Information" icon-name="utility:info">
                            <div class="slds-var-p-around_medium">
                                <template if:true={selectedObject}>
                                    <div class="slds-text-heading_small slds-var-m-bottom_small">
                                        Selected: {selectedObject}
                                    </div>
                                    <template if:true={selectedRecordTypeName}>
                                        <div class="slds-text-body_regular">
                                            Record Type: {selectedRecordTypeName}
                                        </div>
                                    </template>
                                </template>
                                <template if:false={selectedObject}>
                                    <div class="slds-text-align_center">
                                        <lightning-icon icon-name="utility:info" size="large" class="slds-var-m-bottom_small"></lightning-icon>
                                        <p class="slds-text-body_regular slds-text-color_weak">
                                            Select an object to view details
                                        </p>
                                    </div>
                                </template>
                            </div>
                        </lightning-card>
                    </div>
                </div>
            </template>

            <!-- Step 2: Field Selection & Analysis -->
            <template if:true={isStep2}>
                <div class="slds-grid slds-gutters slds-wrap">
                    <div class="slds-col slds-size_1-of-1 slds-large-size_7-of-12">
                        <lightning-card title={fieldSelectionTitle} icon-name="utility:multi_select_checkbox">
                            <div class="slds-var-p-around_medium">
                                
                                <!-- Loading State -->
                                <template if:true={isLoadingFields}>
                                    <div class="slds-text-align_center">
                                        <lightning-spinner alternative-text="Loading fields..." size="small"></lightning-spinner>
                                        <p class="slds-var-m-top_small">Loading fields...</p>
                                    </div>
                                </template>

                                <!-- Field Selection -->
                                <template if:false={isLoadingFields}>
                                    <lightning-dual-listbox
                                        name="fieldSelector"
                                        label="Select Fields for Analysis"
                                        source-label="Available Fields"
                                        selected-label="Selected Fields"
                                        options={availableFields}
                                        value={selectedFields}
                                        onchange={handleFieldSelection}
                                        min="1"
                                        max="50">
                                    </lightning-dual-listbox>

                                    <!-- Selection Summary -->
                                    <template if:true={selectedFields.length}>
                                        <div class="slds-var-m-top_medium">
                                            <div class="slds-badge slds-theme_success">
                                                {selectedFields.length} field(s) selected
                                            </div>
                                        </div>
                                    </template>

                                    <!-- Quick Analysis Button -->
                                    <div class="slds-var-m-top_medium">
                                        <lightning-button
                                            label="Analyze Fields"
                                            variant="brand"
                                            onclick={handleQuickAnalyze}
                                            disabled={quickAnalyzeDisabled}
                                            class="slds-var-m-right_small">
                                        </lightning-button>
                                    </div>
                                </template>
                            </div>
                        </lightning-card>
                    </div>

                    <div class="slds-col slds-size_1-of-1 slds-large-size_5-of-12">
                        <lightning-card title="Field Analysis Preview" icon-name="utility:preview">
                            <div class="slds-var-p-around_medium">
                                
                                <!-- Analysis Loading -->
                                <template if:true={isAnalyzing}>
                                    <div class="slds-text-align_center">
                                        <lightning-spinner alternative-text="Analyzing fields..." size="small"></lightning-spinner>
                                        <p class="slds-var-m-top_small">Analyzing selected fields...</p>
                                    </div>
                                </template>

                                <!-- Analysis Preview -->
                                <template if:true={analysisReport}>
                                    <div class="slds-scrollable_y" style="height: 300px;">
                                        <pre class="slds-text-body_small analysis-text">{analysisReport}</pre>
                                    </div>
                                </template>

                                <!-- Empty State -->
                                <template if:false={analysisReport}>
                                    <template if:false={isAnalyzing}>
                                        <div class="slds-text-align_center">
                                            <lightning-icon icon-name="utility:preview" size="large" class="slds-var-m-bottom_small"></lightning-icon>
                                            <p class="slds-text-body_regular slds-text-color_weak">
                                                Select fields and click "Analyze Fields" to see preview
                                            </p>
                                        </div>
                                    </template>
                                </template>
                            </div>
                        </lightning-card>
                    </div>
                </div>
            </template>

            <!-- Step 3: Create Instructions -->
            <template if:true={isStep3}>
                <lightning-card title="Create Instructions" icon-name="standard:steps">
                    <div class="slds-var-p-around_medium">
                        
                        <!-- Instructions Header -->
                        <div class="slds-grid slds-gutters slds-wrap slds-var-m-bottom_medium">
                            <div class="slds-col slds-size_1-of-1 slds-medium-size_6-of-12">
                                <h3 class="slds-text-heading_small">
                                    Instructions for {selectedObject}
                                </h3>
                                <p class="slds-text-body_small slds-text-color_weak">
                                    Create step-by-step instructions for record creation
                                </p>
                            </div>
                            <div class="slds-col slds-size_1-of-1 slds-medium-size_6-of-12 slds-text-align_right">
                                <lightning-button 
                                    label="Add Step" 
                                    icon-name="utility:add"
                                    variant="brand"
                                    onclick={handleAddInstruction}>
                                </lightning-button>
                            </div>
                        </div>


                        <!-- Instructions List -->
                        <template if:true={instructions.length}>
                            <div class="instructions-container">
                                <template for:each={instructions} for:item="instruction">
                                    <div key={instruction.id} class="slds-box slds-var-m-bottom_small instruction-item">
                                        <div class="slds-grid slds-gutters slds-wrap">
                                            <!-- Step Number -->
                                            <div class="slds-col slds-size_1-of-12">
                                                <div class="step-number">
                                                    <span class="slds-badge">{instruction.stepNumber}</span>
                                                </div>
                                            </div>

                                            <!-- Instruction Content -->
                                            <div class="slds-col slds-size_10-of-12">
                                                <template if:false={instruction.isEditing}>
                                                    <!-- Display Mode -->
                                                    <div class="slds-var-m-bottom_x-small">
                                                        <strong>{instruction.text}</strong>
                                                    </div>
                                                    <template if:true={instruction.fields.length}>
                                                        <div class="slds-text-body_small slds-text-color_weak">
                                                            Fields: 
                                                            <template for:each={instruction.fields} for:item="field" for:index="fieldIndex">
                                                                <span key={field}>
                                                                    {field}<template if:false={fieldIndex.isLast}>, </template>
                                                                </span>
                                                            </template>
                                                        </div>
                                                    </template>
                                                </template>

                                                <template if:true={instruction.isEditing}>
                                                    <!-- Edit Mode -->
                                                    <div class="slds-grid slds-gutters slds-wrap">
                                                        <div class="slds-col slds-size_1-of-1 slds-var-m-bottom_small">
                                                            <lightning-textarea
                                                                label="Instruction"
                                                                value={instruction.text}
                                                                data-id={instruction.id}
                                                                onchange={handleInstructionTextChange}
                                                                required>
                                                            </lightning-textarea>
                                                        </div>
                                                        <div class="slds-col slds-size_1-of-1">
                                                            <lightning-dual-listbox
                                                                label="Select Fields"
                                                                source-label="Available Fields"
                                                                selected-label="Selected Fields"
                                                                options={fieldOptionsForInstructions}
                                                                value={instruction.fields}
                                                                data-id={instruction.id}
                                                                onchange={handleInstructionFieldChange}
                                                                size="5">
                                                            </lightning-dual-listbox>
                                                        </div>
                                                    </div>
                                                </template>
                                            </div>

                                            <!-- Action Buttons -->
                                            <div class="slds-col slds-size_1-of-12 slds-text-align_right">
                                                <template if:false={instruction.isEditing}>
                                                    <lightning-button-menu 
                                                        alternative-text="More actions" 
                                                        icon-size="x-small"
                                                        menu-alignment="right">
                                                        <lightning-menu-item 
                                                            value="edit" 
                                                            label="Edit"
                                                            data-id={instruction.id}
                                                            onselect={handleEditInstruction}>
                                                        </lightning-menu-item>
                                                        <lightning-menu-item 
                                                            value="moveup" 
                                                            label="Move Up"
                                                            data-id={instruction.id}
                                                            onselect={handleMoveInstruction}
                                                            disabled={instruction.isFirst}>
                                                        </lightning-menu-item>
                                                        <lightning-menu-item 
                                                            value="movedown" 
                                                            label="Move Down"
                                                            data-id={instruction.id}
                                                            onselect={handleMoveInstruction}
                                                            disabled={instruction.isLast}>
                                                        </lightning-menu-item>
                                                        <lightning-menu-item 
                                                            value="delete" 
                                                            label="Delete"
                                                            data-id={instruction.id}
                                                            onselect={handleDeleteInstruction}>
                                                        </lightning-menu-item>
                                                    </lightning-button-menu>
                                                </template>
                                                <template if:true={instruction.isEditing}>
                                                    <div class="slds-button-group">
                                                        <lightning-button 
                                                            label="Save" 
                                                            variant="success"
                                                            size="small"
                                                            data-id={instruction.id}
                                                            onclick={handleSaveInstruction}>
                                                        </lightning-button>
                                                        <lightning-button 
                                                            label="Cancel" 
                                                            variant="neutral"
                                                            size="small"
                                                            data-id={instruction.id}
                                                            onclick={handleCancelEditInstruction}>
                                                        </lightning-button>
                                                    </div>
                                                </template>
                                            </div>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </template>

                        <!-- Empty State for Instructions -->
                        <template if:false={instructions.length}>
                            <div class="slds-text-align_center slds-var-p-vertical_large">
                                <lightning-icon icon-name="utility:steps" size="large" variant="base"></lightning-icon>
                                <h3 class="slds-text-heading_medium slds-var-m-top_medium">No instruction steps yet</h3>
                                <p class="slds-text-body_regular slds-var-m-top_small">
                                    Create step-by-step instructions to guide users through the record creation process.
                                </p>
                                <lightning-button 
                                    label="Add First Step" 
                                    variant="brand"
                                    class="slds-var-m-top_medium"
                                    onclick={handleAddInstruction}>
                                </lightning-button>
                            </div>
                        </template>
                    </div>
                </lightning-card>
            </template>

            <!-- Step 4: Review & Save -->
            <template if:true={isStep4}>
                <div class="slds-grid slds-gutters slds-wrap">
                    <div class="slds-col slds-size_1-of-1 slds-large-size_6-of-12">
                        <lightning-card title="Analysis Summary" icon-name="utility:summary">
                            <div class="slds-var-p-around_medium">
                                <div class="slds-text-body_regular slds-var-m-bottom_small">
                                    <strong>Object:</strong> {selectedObject}
                                </div>
                                <template if:true={selectedRecordTypeName}>
                                    <div class="slds-text-body_regular slds-var-m-bottom_small">
                                        <strong>Record Type:</strong> {selectedRecordTypeName}
                                    </div>
                                </template>
                                <div class="slds-text-body_regular slds-var-m-bottom_small">
                                    <strong>Selected Fields:</strong> {selectedFields.length}
                                </div>
                                <div class="slds-text-body_regular slds-var-m-bottom_small">
                                    <strong>Instructions:</strong> {instructions.length} steps
                                </div>
                                
                                <!-- Field List -->
                                <div class="slds-var-m-top_medium">
                                    <h4 class="slds-text-heading_small slds-var-m-bottom_small">Fields:</h4>
                                    <div class="slds-scrollable_y" style="height: 150px;">
                                        <template for:each={selectedFields} for:item="field">
                                            <div key={field} class="slds-text-body_small">• {field}</div>
                                        </template>
                                    </div>
                                </div>
                            </div>
                        </lightning-card>
                    </div>
                    
                    <div class="slds-col slds-size_1-of-1 slds-large-size_6-of-12">
                        <lightning-card title="Instructions Preview" icon-name="standard:steps">
                            <div class="slds-var-p-around_medium">
                                <template if:true={instructions.length}>
                                    <div class="slds-scrollable_y" style="height: 300px;">
                                        <template for:each={instructions} for:item="instruction">
                                            <div key={instruction.id} class="slds-var-m-bottom_small">
                                                <div class="slds-text-body_regular">
                                                    <span class="slds-badge slds-var-m-right_x-small">{instruction.stepNumber}</span>
                                                    {instruction.text}
                                                </div>
                                                <template if:true={instruction.fields.length}>
                                                    <div class="slds-text-body_small slds-text-color_weak slds-var-m-left_medium">
                                                        Fields: {instruction.fields}
                                                    </div>
                                                </template>
                                            </div>
                                        </template>
                                    </div>
                                </template>
                                <template if:false={instructions.length}>
                                    <div class="slds-text-align_center slds-text-color_weak">
                                        No instructions created
                                    </div>
                                </template>
                            </div>
                        </lightning-card>
                    </div>
                </div>

                <!-- Save Analysis Section -->
                <div class="slds-var-m-top_large slds-text-align_center">
                    <lightning-card>
                        <div class="slds-var-p-around_medium">
                            <h3 class="slds-text-heading_small slds-var-m-bottom_medium">Save Analysis</h3>
                            <template if:true={isSaving}>
                                <lightning-spinner alternative-text="Saving analysis..." size="small"></lightning-spinner>
                                <p class="slds-var-m-top_small">Saving analysis and instructions...</p>
                            </template>
                            <template if:false={isSaving}>
                                <lightning-button
                                    label="Save Complete Analysis"
                                    variant="brand"
                                    onclick={handleSaveCompleteAnalysis}
                                    class="slds-var-m-horizontal_small">
                                </lightning-button>
                                <lightning-button
                                    label="Start Over"
                                    variant="neutral"
                                    onclick={handleStartOver}>
                                </lightning-button>
                            </template>
                        </div>
                    </lightning-card>
                </div>
            </template>
        </div>

        <!-- Navigation Footer -->
        <div class="slds-var-p-around_medium slds-border_top">
            <div class="slds-grid slds-grid_align-spread">
                <div class="slds-col">
                    <template if:false={isStep1}>
                        <lightning-button
                            label="Previous"
                            variant="neutral"
                            onclick={handlePrevious}
                            icon-name="utility:chevronleft"
                            icon-position="left">
                        </lightning-button>
                    </template>
                </div>
                <div class="slds-col">
                    <template if:false={isStep4}>
                        <lightning-button
                            label="Next"
                            variant="brand"
                            onclick={handleNext}
                            disabled={nextDisabled}
                            icon-name="utility:chevronright"
                            icon-position="right">
                        </lightning-button>
                    </template>
                </div>
            </div>
        </div>

    </lightning-card>
</template>